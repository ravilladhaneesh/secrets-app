{% extends "layout.html" %}

{% block content%}
    <div class="secret-container container">

        <div class="heading-container">
            <h2> Secrets</h2>
            <button class="add-secret-btn" onclick="toggleSecretForm()">Add Secret</button>
        </div>

        <!-- Add Secret Form (Initially Hidden) -->
        <div id="add-secrets" style="display: none;">
            <form action="#" method="POST">
                {{ form.hidden_tag() }}
                {% if form.errors %}
                    <div class="alert alert-danger">
                        <ul>
                            {% for field, errors in form.errors.items() %}
                                {% for error in errors %}
                                    <li><strong>{{ form[field].label.text }}:</strong> {{ error }}</li>
                                {% endfor %}
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}
            
                <!-- Secret Name -->
                <div class="form-group">
                    <label for="name">Secret Name:</label>
                    {{ form.name(class="form-control") }}
                </div>

                <!-- Secret Value -->
                <div class="form-group">
                    <label for="secret">Secret:</label>
                    {{ form.secret(class="form-control") }}
                </div>

                <!-- Nominee Fields -->
                <div class="form-group">
                    <label>Nominees:</label>
                    {% for nominee in form.nominees %}
                    <div class="nominee-container">
                        <label for="nominees-{{ loop.index }}">Nominee {{ loop.index }}:</label>
                        <table id="nominees-{{ loop.index }}">
                            <tr>
                                <th><label for="nominees-{{ loop.index }}-name">Nominee Name</label></th>
                                <td>{{ nominee.name(class="form-control") }}</td>
                            </tr>
                            <tr>
                                <th><label for="nominees-{{ loop.index }}-email_id">Email</label></th>
                                <td>{{ nominee.email_id(class="form-control") }}</td>
                            </tr>
                        </table>
                    </div>
                    {% endfor %}
                </div>

                <button type="button" class="add-nominee-btn" onclick="addNominees()">Add Nominee</button>
                <div id="nominee-fields"></div>

                <!-- Submit and Cancel Buttons -->
                <div class="button-container">
                    <button type="submit" class="add-secret-btn">Submit Secret</button>
                    <button type="button" class="cancel-secret-btn" onclick="cancelSecretForm()">Cancel</button>
                </div>
            </form>
        </div>

        <hr>

        <!-- Display Existing Secrets in a Table -->
        <table id="secrets-table">
            <thead>
                <tr>
                    <th>Secret Name</th>
                    <th>Nominees</th>
                    <th>Details</th>
                    <th>Edit</th>
                    <th>Delete</th>
                </tr>
            </thead>
            <tbody>
                {% for secret in secrets %}
                <tr>
                    <td>{{ secret.fieldName }}</td>
                    <td>
                        {% if secret.nominees|length > 3 %}
                            {% for nominee in secret.nominees[:3] %}
                                {{ nominee.name }} <br>
                            {% endfor %}
                            <span>...</span>
                        {% else %}
                            {% for nominee in secret.nominees %}
                                {{ nominee.name }} <br>
                            {% endfor %}
                        {% endif %}
                    </td>
                    <td><button onclick="showSecretDetails({{secret}})">View Details</button></td>
                    <td><button onclick="window.location.href = '{{ url_for('edit_secret', secretId=secret.id ) }}'">Edit</button></td>
                    <td><button class="del-secret-btn" onclick="showDeleteAlert({{secret}}, `{{url_for('delete_secret', secretId=secret.id)}}`)">Delete</button></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- Overlay for Secret Details Popup -->
        <div id="overlay">
            <div id="details-popup" class="popup-box" style="display: none;">
                <h3 id="secret-name"></h3>
                <p id="secret-value">Value</p>
                <ul id="nominee-list">
                    <!-- Nominee List Will Appear Here -->
                </ul>
                <button class="close-btn" onclick="closePopup()">Close</button>
            </div>
            <div id="del-secret-consent" class="popup-box" style="display: none;">
                <h3 id="del-secret-name">Secret Name</h3>
                <p id="del-consent-text">Are you sure you want to delete the secret?<strong><i>The secret will be permanently deleted.</i> </strong></p>
                <button class="close-btn" onclick="closePopup()">Cancel</button>
                <button class="del-secret-btn">Delete</button>
            </div>
        </div>
    </div>
{% endblock content %}